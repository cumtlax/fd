"""flower-tutorial: A Flower / PyTorch app."""

import torch

# ArrayRecord	Flower ä¸­ç”¨äºå­˜å‚¨æ¨¡å‹å‚æ•°çš„æ•°æ®ç»“æ„ï¼ˆç±»ä¼¼å­—å…¸ï¼‰
# ConfigRecord	å­˜å‚¨é…ç½®ä¿¡æ¯ï¼ˆå¦‚è¶…å‚æ•°ï¼‰
# Context	åŒ…å«å½“å‰è¿è¡Œç¯å¢ƒçš„ä¿¡æ¯ï¼ˆæ¯”å¦‚ç”¨æˆ·ä¼ å…¥çš„é…ç½®ï¼‰
from flwr.app import ArrayRecord, ConfigRecord, Context

# ServerApp	Flower çš„æœåŠ¡å™¨ç«¯ä¸»ç±»ï¼Œå®šä¹‰æœåŠ¡å™¨è¡Œä¸º
# Grid	è¡¨ç¤ºæ‰€æœ‰å®¢æˆ·ç«¯æäº¤çš„ç»“æœé›†åˆï¼ˆæ¥è‡ªå®¢æˆ·ç«¯çš„æ¨¡å‹æ›´æ–°ï¼‰
from flwr.serverapp import Grid, ServerApp

# FedAvg	ç»å…¸çš„è”é‚¦å¹³å‡ç®—æ³•ï¼ˆFederated Averagingï¼‰
from flwr.serverapp.strategy import FedAvg

# Net	ä½ è‡ªå·±å®šä¹‰çš„ç¥ç»ç½‘ç»œæ¨¡å‹ï¼ˆæ¯”å¦‚ CNNï¼‰
from flower_tutorial.task import Net

# åˆ›å»ºä¸€ä¸ª Flower æœåŠ¡å™¨åº”ç”¨å®ä¾‹
# Create ServerApp
app = ServerApp()

#  main å‡½æ•°æ˜¯ è”é‚¦å­¦ä¹ æœåŠ¡å™¨çš„â€œæŒ‡æŒ¥ä¸­å¿ƒâ€ï¼Œå®ƒï¼š
# è¯»å–è®­ç»ƒé…ç½®ï¼ˆå¦‚è½®æ•°ã€å­¦ä¹ ç‡ï¼‰
# åˆå§‹åŒ–å…¨å±€æ¨¡å‹
# å¯åŠ¨ FedAvg ç­–ç•¥ï¼Œåè°ƒå¤šä¸ªå®¢æˆ·ç«¯è¿›è¡Œå¤šè½®è®­ç»ƒ
# æœ€ç»ˆèšåˆå‡ºä¸€ä¸ªå…¨å±€æ¨¡å‹å¹¶ä¿å­˜åˆ°ç£ç›˜

#  @app.main()
# è¿™æ˜¯ä¸€ä¸ª è£…é¥°å™¨ï¼ˆdecoratorï¼‰
# å®ƒå‘Šè¯‰ Flower æ¡†æ¶ï¼šâ€œè¿™ä¸ªå‡½æ•°æ˜¯ ServerApp å¯åŠ¨æ—¶çš„ä¸»å…¥å£â€
# ç±»ä¼¼äºç¨‹åºçš„ main() å‡½æ•°
# grid: è¡¨ç¤ºæ‰€æœ‰å®¢æˆ·ç«¯èŠ‚ç‚¹çš„é›†åˆï¼ˆé€»è¾‘ä¸Šçš„â€œç½‘æ ¼â€ï¼‰
# ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºâ€œæ‰€æœ‰æ³¨å†Œçš„å®¢æˆ·ç«¯åˆ—è¡¨â€
# åœ¨ strategy.start() ä¸­ç”¨äºè°ƒåº¦å®¢æˆ·ç«¯
# context: å½“å‰è¿è¡Œçš„ä¸Šä¸‹æ–‡ç¯å¢ƒ
# åŒ…å«ç”¨æˆ·ä¼ å…¥çš„é…ç½®å‚æ•°ï¼ˆå¦‚ num-server-roundsï¼‰
# æ˜¯ä¸€ä¸ªå­—å…¸-like å¯¹è±¡ï¼Œå¯é€šè¿‡ context.run_config["key"] è®¿é—®
# -> None: è¿™ä¸ªå‡½æ•°ä¸è¿”å›æœ‰æ„ä¹‰çš„å€¼ï¼ˆæœ€ç»ˆç»“æœé€šè¿‡ result è·å–ï¼‰
@app.main()
def main(grid: Grid, context: Context) -> None:
    """è¿™æ˜¯æœåŠ¡å™¨çš„â€œä¸»ç¨‹åºâ€ï¼Œå°±åƒç”µè„‘çš„å¼€æœºå¯åŠ¨é¡¹"""

    # ç¬¬ä¸€æ­¥ï¼šè¯»å–ç”¨æˆ·è®¾ç½®çš„å‚æ•°
    # æ¯”å¦‚ï¼šæ¯è½®é€‰ 30% çš„å®¢æˆ·ç«¯ï¼Œæ€»å…±è®­ç»ƒ 5 è½®ï¼Œå­¦ä¹ ç‡æ˜¯ 0.001
    fraction_train = context.run_config["fraction-train"]      # æ¯è½®é€‰å¤šå°‘æ¯”ä¾‹çš„å®¢æˆ·ç«¯
    num_rounds     = context.run_config["num-server-rounds"]   # æ€»å…±è®­ç»ƒå‡ è½®
    learning_rate  = context.run_config["lr"]                  # å­¦ä¹ ç‡

    # ç¬¬äºŒæ­¥ï¼šåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„æ¨¡å‹ï¼ˆæ¯”å¦‚ CNNï¼‰
    # å°±åƒå‘ä¸€å¼ ç™½çº¸ç»™ç¬¬ä¸€ä¸ªå­¦ç”Ÿï¼Œè®©ä»–å¼€å§‹ç”»å›¾
    model = Net()  # åˆ›å»ºæ¨¡å‹ï¼ˆç»“æ„å·²çŸ¥ï¼Œä½†å‚æ•°æ˜¯éšæœºçš„ï¼‰

    # æŠŠæ¨¡å‹çš„â€œå‚æ•°â€æ‰“åŒ…æˆ Flower èƒ½ä¼ è¾“çš„æ ¼å¼
    initial_weights = ArrayRecord(model.state_dict())

    # ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®è”é‚¦å­¦ä¹ è§„åˆ™ â€”â€” ä½¿ç”¨ FedAvgï¼ˆè”é‚¦å¹³å‡ï¼‰
    # å°±åƒè€å¸ˆè¯´ï¼šâ€œæ¯è½®éšæœºå«å‡ ä¸ªåŒå­¦ä¸Šæ¥åˆ†äº«ä½œä¸šï¼Œæˆ‘å–å¹³å‡å€¼æ›´æ–°å…¨ç­ç­”æ¡ˆâ€
    strategy = FedAvg(
        fraction_train=fraction_train,  # æ¯è½®é€‰ fraction_train æ¯”ä¾‹çš„å®¢æˆ·ç«¯
    )

    # ç¬¬å››æ­¥ï¼šå¼€å§‹è”é‚¦å­¦ä¹ ï¼
    # è®©å®¢æˆ·ç«¯ä»¬è½®æµè®­ç»ƒï¼Œå…± num_rounds è½®
    # æœåŠ¡å™¨ä¼šè‡ªåŠ¨ï¼š
    #   - ä¸‹å‘æ¨¡å‹ â†’ å®¢æˆ·ç«¯è®­ç»ƒ â†’ ä¸Šä¼ æ›´æ–° â†’ èšåˆ â†’ æ›´æ–°å…¨å±€æ¨¡å‹
    result = strategy.start(
        grid=grid,                # æ‰€æœ‰å®¢æˆ·ç«¯çš„é›†åˆï¼ˆFlower è‡ªåŠ¨ç®¡ç†ï¼‰
        initial_arrays=initial_weights,  # åˆå§‹æ¨¡å‹å‚æ•°
        train_config=ConfigRecord({"lr": learning_rate}),  # å‘ç»™å®¢æˆ·ç«¯çš„é…ç½®
        num_rounds=num_rounds,    # æ€»å…±è®­ç»ƒå¤šå°‘è½®
    )

    # ç¬¬äº”æ­¥ï¼šè®­ç»ƒç»“æŸï¼Œä¿å­˜æœ€ç»ˆæ¨¡å‹
    print("âœ… è”é‚¦å­¦ä¹ å·²å®Œæˆï¼æ­£åœ¨ä¿å­˜æœ€ç»ˆæ¨¡å‹...")

    # æŠŠ Flower æ ¼å¼çš„æ¨¡å‹è½¬å› PyTorch æ ¼å¼
    final_state_dict = result.arrays.to_torch_state_dict()

    # ä¿å­˜åˆ°æ–‡ä»¶ "final_model.pt"
    torch.save(final_state_dict, "final_model.pt")

    print("ğŸ‰ æ¨¡å‹å·²ä¿å­˜ï¼šfinal_model.pt")